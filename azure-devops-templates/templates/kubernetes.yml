steps:

  - task: CmdLine@2
    displayName: configure kubeconfig
    inputs:
      script: |
        set -e
        aws eks update-kubeconfig --region $(region) --name ${{ parameters.env }} --profile ${{ parameters.env }}
      workingDirectory: "$(Build.Repository.LocalPath)/$(apppath)"

  - task: CmdLine@2
    displayName: deploy
    inputs:
      script: |
        set -e
        aws eks update-kubeconfig --region $(region) --name ${{ parameters.env }} --profile ${{ parameters.env }}
        cd cd/${{ parameters.env }}
        new_image=$(subs_id).dkr.ecr.$(region).amazonaws.com/$(appname)-${{ parameters.env }}:$(Build.BuildId)
        echo "##[section]Deploying image: $new_image"
        sed -i "s|image: .*|image: ${new_image}|" deployment.yaml
        cat deployment.yaml
        kubectl apply -f deployment.yaml
        author=$(git log -1 --pretty=format:'%ae')
        git config --global user.name "$author"
        git config --global user.email "$author"
        git add .
        git commit -m "v$(Build.BuildNumber)"
        if [ "${{ parameters.env }}" = "prod" ]; then
          target_branch="main"
        else
          target_branch="stage"
        fi
        echo "##[section]Pushing to branch: $target_branch"
        git push origin HEAD:$target_branch
      workingDirectory: "$(Build.Repository.LocalPath)/$(apppath)"